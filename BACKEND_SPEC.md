# Backend spec (Admin auth + blog content + GitHub publish)

This repo currently runs as a static site (Vite + React). The new `src/pages/Admin.jsx` is a **client-only editor** (draft + export), but it cannot publish to GitHub or write `src/data/data.js` from the browser.

To make publishing one-click, you need a small backend (can be **serverless functions** on Vercel/Netlify/Cloudflare). The backend:

- authenticates a single admin
- stores content (optional, in DB)
- can commit generated files to GitHub (recommended) to trigger GitHub Pages rebuild

---

## 1) Security notes (must follow)

- Never store plaintext passwords.
- Store `password_hash` generated by **Argon2id** (preferred) or bcrypt.
- Use **HTTPS only**.
- Use **HttpOnly + Secure cookies** for sessions, or short-lived JWT + refresh token.
- Add rate-limiting on login.
- Validate & sanitize inputs (slug uniqueness, required fields, max sizes).

---

## 2) Minimal endpoints (simplest working backend)

### Auth

#### `POST /api/auth/login`
Logs in the admin and creates a session.

Request:
```json
{ "username": "admin", "password": "..." }
```
Response:
- `200` + `Set-Cookie: session=...; HttpOnly; Secure; SameSite=Lax`
- body: `{ "ok": true }`

Errors:
- `401` invalid credentials
- `429` too many attempts

#### `POST /api/auth/logout`
Deletes the session.

Response: `200 { "ok": true }`

#### `GET /api/auth/me` (optional)
Returns session info.

Response:
```json
{ "isAuthenticated": true, "username": "admin" }
```

---

### Content API

You can store the whole blog post body as Markdown in a `TEXT` column.

#### `GET /api/posts`
List posts.

Response:
```json
{ "posts": [ { "id": 1, "slug": "...", "title": "...", "excerpt": "...", "content": "# md..." } ] }
```

#### `GET /api/posts/:id`
Returns full post.

#### `POST /api/posts`
Create post.

#### `PUT /api/posts/:id`
Update post.

#### `DELETE /api/posts/:id`
Delete post.

**All post endpoints require auth.**

---

### Publish to GitHub (recommended)

The easiest publishing model for GitHub Pages is:
- DB is for drafts (optional)
- Source of truth is Git (repo)
- publish endpoint commits content to repo and pushes

#### `POST /api/publish`
Generates files (either `src/data/data.js` OR `content/posts/*.md`) and commits to GitHub.

Request example (backend decides output):
```json
{
  "message": "Update posts",
  "posts": [
    {
      "id": 1,
      "slug": "binky-co-to-znamena",
      "title": "Binky...",
      "excerpt": "...",
      "category": "Správanie",
      "author": "Tím Zajkológia",
      "date": "2026-01-01",
      "image": "/zajo.png",
      "content": "# Markdown..."
    }
  ],
  "categories": [
    { "id": 1, "name": "Strava", "slug": "strava", "color": "#B09398" }
  ]
}
```
Response:
```json
{ "commitSha": "abc123", "commitUrl": "https://github.com/<org>/<repo>/commit/abc123" }
```

Implementation notes:
- use GitHub API to create/update blobs + commit + update branch ref
- store GitHub credentials as env vars on the backend only
- GitHub Pages rebuild triggers on push automatically

**GitHub auth options**
- simplest: a fine-grained PAT stored as `GITHUB_TOKEN` (server-side only)
- better: GitHub App (more secure, scoped permissions)

---

## 3) SQL schema (PostgreSQL)

### Admins
Stores admin accounts. For single-admin, you can seed one row.

```sql
create table admins (
  id bigserial primary key,
  username text not null unique,
  password_hash text not null,
  is_active boolean not null default true,
  created_at timestamptz not null default now(),
  last_login_at timestamptz
);

create index admins_is_active_idx on admins (is_active);
```

### Sessions (cookie-based auth)

```sql
create table admin_sessions (
  id bigserial primary key,
  admin_id bigint not null references admins(id) on delete cascade,
  session_token_hash text not null unique,
  created_at timestamptz not null default now(),
  expires_at timestamptz not null,
  revoked_at timestamptz,
  ip inet,
  user_agent text
);

create index admin_sessions_admin_id_idx on admin_sessions (admin_id);
create index admin_sessions_expires_at_idx on admin_sessions (expires_at);
```

Notes:
- store only a **hash** of the session token in DB (like password hashing)
- session cookie contains the raw token

### Categories

```sql
create table categories (
  id bigserial primary key,
  name text not null unique,
  slug text not null unique,
  color text,
  created_at timestamptz not null default now()
);
```

### Posts
Markdown body is stored as `text`.

```sql
create table posts (
  id bigserial primary key,
  slug text not null unique,
  title text not null,
  excerpt text,
  content_md text not null,
  image_url text,
  author text,
  category_id bigint references categories(id) on delete set null,
  published_at timestamptz,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create index posts_category_id_idx on posts (category_id);
create index posts_published_at_idx on posts (published_at);
```

If you prefer storing the category name directly (no FK), you can replace `category_id` with `category text`.

---

## 4) Can the admin page edit `data.js` directly (no DB)?

Not safely from a browser.

- The React app runs in the user’s browser and cannot write to your repo or server filesystem.
- You must either:
  1) use a backend to commit changes to GitHub, or
  2) use a Git-based CMS (Decap CMS) that commits to GitHub, or
  3) export files and commit manually.

The implemented `src/pages/Admin.jsx` supports option (3) today.
